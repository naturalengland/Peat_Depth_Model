---
title: "Peat Depth Model: Predict"
params:
  params_fn: 
    input: file
    label: 'Select parameters to import (.rds)'
    value: "../data/parameters_eng.rds"
output:
    html_notebook:
    html_document:
    df_print: paged

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo= TRUE)
```

-------  

Run at `r Sys.time()` for **`r params$area_name`** (*`r params$area_abbr`*) with the following parameters: 

```{r, echo=FALSE}
#import parameters from previous runs
parameters <- readRDS(file = params$params_fn)

# if you need to change any imported parameters, do it here, e.g.: 
  #parameters$existing_parameter <- newvalue
  #parameters$new_parameter <- value

# add new parameters from yaml header

  # automatically defined session variables 
  #set current time and date to append to run log 

# print list of all parameters
parameters
  
#set params for script
par.ori <- par() #save default plotting parameters


```


-------    

## Introduction

This script predicts peat depths from models created in previous scripts.  It outputs:   

*   a raster of predicted depths
*   a raster of prediction variance



```{r}
#load packages
library(tidyverse)#
library(raster)
library(rgdal)
library(sp)
library(sf)
library(elevatr)
library(geoR)
library(gstat)
library(stars)
```
## 1. Import previously prepared data

```{r}
model.geo <- readRDS("~/GitHub/Peat_Depth_Model/england/outputs/model.geo_eng_run_20200823-1202.rds")
sp_depth <- readRDS(parameters$inputs_fn)
```

```{r}
summary(model.geo)
```


```{r}
# import elevation and slope

elevation_st <- stars::read_stars(parameters$elev_raster_fn)
slope_st <- read_stars(parameters$slope_raster_fn)
 
preds_st <- c(elev = elevation_st, slope = slope_st)
names(preds_st) <- c("elev", "slope")

#rm(elevation_st, slope_st)

#plot(preds_st[1])

```

$from
[1] 1

$to
[1] 114203

$offset
[1] 82540

$delta
[1] 5


$point
[1] FALSE

$values
NULL

$from
[1] 1

$to
[1] 128824

$offset
[1] 649256

$delta
[1] -5

*reasonable tile size for kriging*
x = 10000
y = 4000
~0.3Gb per tile

```{r}
tracking <- cbind(i = as.integer(), xoff = as.numeric(), yoff = as.numeric(), 
                  Gb = as.character(), seconds = as.numeric()) %>% data.frame()


#calculate tiles
elev_dims <- st_dimensions(elevation_st)
slope_dims <- st_dimensions(slope_st)

xmax  <- elev_dims$x$to
ymax  <- elev_dims$y$to
xsize <- 10000
ysize <- 4000

xnfull      <- round(xmax/xsize, digits = 0) 
xremainder  <- xmax-(xsize*xnfull)
ynfull      <- round(ymax/ysize, digits = 0) 
yremainder  <- ymax-(ysize*ynfull)

tiles <- data.frame(xoff = rep(seq(1, by = xsize, length.out = xnfull+1), ynfull+1), 
                    yoff = rep(seq(1, by = ysize, length.out = ynfull+1), each = xnfull+1),
                    xsize = rep(c(rep(xsize, length.out = xnfull), xremainder), ynfull+1),
                    ysize = c(rep(ysize, length.out = (xnfull+1)*ynfull), rep(yremainder, xnfull+1)))

for(i in 187){    #nrow(tiles)) {
start <- Sys.time()

xoff <- tiles$xoff[i]; yoff <- tiles$yoff[i]; xsize <- tiles$xsize[i]; ysize <- tiles$ysize[i]

rasterio <- list(nXOff = xoff, nYOff = yoff, nXSize = xsize, nYSize = ysize, bands = c(1))
elev_tile <- read_stars(parameters$elev_raster_fn, RasterIO = rasterio, proxy = F, quiet = F)
slope_tile <- read_stars(parameters$slope_raster_fn, RasterIO = rasterio, proxy = F, quiet = F)
#write tile to raster object
write_stars(elev_tile, paste0("../data/elev_tile", i, "_x", xoff, "_y", yoff, ".tif"))
write_stars(slope_tile, paste0("../data/slope_tile", i, "_x", xoff, "_y", yoff, ".tif"))

elev_tile <- raster(paste0("../data/elev_tile", i, "_x", xoff, "_y", yoff, ".tif"))
slope_tile <- raster(paste0("../data/slope_tile", i, "_x", xoff, "_y", yoff, ".tif"))
preds_tile <- stack(elev_tile, slope_tile)
names(preds_tile) <- c("elev", "slope")

# preds_tile <- c(elev_tile, slope_tile) #stack
# names(preds_tile) <- c("elev", "slope")
# elev_tile_sf <- stass

#preds_tile <- st_as_sfc(preds_tile, as_points = T)
elev_tile_sf <- st_as_sf(elev_tile, as_points = T,  merge = F)
slope_tile_sf <- st_as_sf(slope_tile, as_points = T,  merge = F)

preds_tile_sf <- sf::st_join(elev_tile_sf, slope_tile_sf, left = F)
names(preds_tile_sf) <- c("elev", "slope", "geometry")

rm(elev_tile, slope_tile)  # make space in memory

sp_depth <- sp::spTransform(sp_depth, CRSobj = CRS("+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.1502,0.247,0.8421,-20.48939999999 +units=m +no_defs"))
depth_sf <- st_as_sf(sp_depth)
st_crs(depth_sf) <- st_crs(preds_tile_sf)


Gb <- object.size(preds_tile_sf)/1000000000 #calc size in memory
print(as.character(c(i = i, xoff = xoff, yoff = xoff, Gb = Gb)))

                                                                                                      krige_out <- gstat::krige(formula = cbrt_depth ~ elev + slope, maxdist = 500, 
                          locations = depth_sf, 
                          newdata = preds_tile, 
                          model = model.geo)

write_stars(krige_out["var1.pred"], paste0("../outputs/pred_tile", i, "_x", xoff, "_y", yoff, ".tif"))
write_stars(krige_out["var1.var"], paste0("../outputs/var_tile", i, "_x", xoff, "_y", yoff, ".tif"))

end <- Sys.time(); time <- difftime(end, start, units = "mins")
tracking <- rbind(tracking, c(i = i, xoff = xoff, yoff = yoff, Gb = Gb, minutes = time))
names(tracking) <- c("i", "xoff", "yoff", "Gb", "minutes")

rm(preds_tile, krige_out) # make space in memory
}


```
Error in predict.gstat(g, newdata = newdata, block = block, nsim = nsim,  : 
  out of dynamic memory (try local kriging?)
  
  [1] "191"         "100001"      "100001"      "0.640013488"
[using universal kriging]
GDAL Error 5: F:\Users\Bruce\Documents\GitHub\Peat_Depth_Model\england\data\elev_eng_5m.tif: Access window out of range in RasterIO().  Requested (110000,60000) of size 10000x4000 on raster of 114203x128824.Error in CPL_read_gdal(as.character(x), as.character(options), as.character(driver),  : 
  read failure

```{r}
temp_tile <- read_stars(paste0("../outputs/var_tile187_x60001_y60001.tif"))
plot(temp_tile)
```


```{r}
sf::st_coordinates(x)
sf::st_crs(x)
stars::st_raster_type(x)
```






```{r}
nxoff <- 100000
nyoff <- 50000
rasterio <- list(nXOff = nxoff, nYOff = nyoff, nXSize = 114203-nxoff, nYSize = 128824-nyoff, bands = c(1))
x <- read_stars(parameters$elev_raster_fn, RasterIO = rasterio, proxy = T, quiet = F)
plot(x)
```



```{r}
gstat::krige(formula = cbrt_depth ~ elev + slope, locations = sp_depth, 
                   newdata = preds_st, model = model.geo)
```






```{r}
input.data.gs <- input.data.sp #spdf format

#remove duplicates 
input.data.gs <- remove.duplicates(obj = input.data.gs)

sp_depth <- input.data.gs

```





```{r}
# sp_depth <- sp::spTransform(x = sp_depth, CRSobj = "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +a=6377563.396 +rf=299.324975315035 +towgs84=446.448,-125.157,542.06,0.1502,0.247,0.8421,-20.48939999999 +units=m +no_defs")
```


```{r}
# preds_st <- st_transform_proj(x = preds_st, crs = "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.1502,0.247,0.8421,-20.48939999999 +units=m +no_defs")
# 
# preds_st <- st_transform_proj(x = preds_st, crs = proj4string(sp_depth))
```

```{r}
#ggplot() + geom_stars(preds_st) + coord_equal()
```

```{r}
# library(ggplot2)
# ggplot() + geom_stars(data = preds_st) +
#     coord_equal() +
#     facet_wrap(~band) +
#     theme_void() +
#     scale_x_discrete(expand=c(0,0))+
#     scale_y_discrete(expand=c(0,0))
```



## Prediction


```{r}
krige.out <- krige(formula = sqrt_depth ~ elev + slope, 
                   locations = sp_depth,
                   newdata = preds_st,
                   model = model.geo)
```

```{r}
saveRDS(object = krige.out, file = paste0("../outputs/krige.out_", 
                      parameters$area_abbr, "_",
                      rundate, ".rds"))
```


```{r}
class(krige.out)
str(krige.out)
plot(krige.out)
```

```{r}
stars::write_stars()

methods(class = "stars")
```

```{r}
krige.pred.rst <- raster(krige.out$var1.pred)
krige.var.rst <- raster(krige.out$var1.var)

writeRaster(x = krige.pred.rst, 
            filename = paste0("../outputs/krige.pred_", parameters$area_abbr, "_",
                      rundate, ".tif"))

writeRaster(x = krige.var.rst, 
            filename = paste0("../outputs/krige.var_", parameters$area_abbr, "_",
                      rundate, ".tif"))

rm(krige.pred.rst, krige.var.rst)
rm(krige.out)

```







